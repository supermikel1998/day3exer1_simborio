'use strict';
sap.ui.define([
    'sap/ui/model/json/JSONModel',
    'sap/ui/dt/OverlayRegistry',
    'open/ux/preview/client/thirdparty/@sap-ux-private/control-property-editor-common',
    '../../i18n',
    '../../cpe/communication-service',
    '../control-utils',
    '../command-executor',
    '../api-handler',
    './BaseDialog.controller',
    '../utils',
    '../quick-actions/control-types'
], function (JSONModel, OverlayRegistry, ___sap_ux_private_control_property_editor_common, ____i18n, ____cpe_communication_service, __ControlUtils, __CommandExecutor, ___api_handler, __BaseDialog, ___utils, ___quick_actions_control_types) {
    'use strict';
    function _interopRequireDefault(obj) {
        return obj && obj.__esModule && typeof obj.default !== 'undefined' ? obj.default : obj;
    }
    const setApplicationRequiresReload = ___sap_ux_private_control_property_editor_common['setApplicationRequiresReload'];
    const getResourceModel = ____i18n['getResourceModel'];
    const getTextBundle = ____i18n['getTextBundle'];
    const CommunicationService = ____cpe_communication_service['CommunicationService'];
    const ControlUtils = _interopRequireDefault(__ControlUtils);
    const CommandExecutor = _interopRequireDefault(__CommandExecutor);
    const getFragments = ___api_handler['getFragments'];
    const BaseDialog = _interopRequireDefault(__BaseDialog);
    const notifyUser = ___utils['notifyUser'];
    const ANALYTICAL_TABLE_TYPE = ___quick_actions_control_types['ANALYTICAL_TABLE_TYPE'];
    const GRID_TABLE_TYPE = ___quick_actions_control_types['GRID_TABLE_TYPE'];
    const TREE_TABLE_TYPE = ___quick_actions_control_types['TREE_TABLE_TYPE'];
    const radix = 10;
    const AddFragment = BaseDialog.extend('open.ux.preview.client.adp.controllers.AddFragment', {
        constructor: function _constructor(name, overlays, rta, options) {
            BaseDialog.prototype.constructor.call(this, name);
            this.options = options;
            this.rta = rta;
            this.overlays = overlays;
            this.model = new JSONModel({
                title: options.title,
                completeView: options.aggregation === undefined
            });
            this.commandExecutor = new CommandExecutor(this.rta);
        },
        setup: async function _setup(dialog) {
            this.dialog = dialog;
            this.setEscapeHandler();
            await this.buildDialogData();
            const resourceModel = await getResourceModel('open.ux.preview.client');
            this.dialog.setModel(resourceModel, 'i18n');
            this.dialog.setModel(this.model);
            this.dialog.open();
        },
        onAggregationChanged: function _onAggregationChanged(event) {
            const source = event.getSource();
            const selectedKey = source.getSelectedKey();
            const selectedItem = source.getSelectedItem();
            let selectedItemText = '';
            if (selectedItem) {
                selectedItemText = selectedItem.getText();
            }
            this.model.setProperty('/selectedAggregation/key', selectedKey);
            this.model.setProperty('/selectedAggregation/value', selectedItemText);
            let newSelectedControlChildren = Object.keys(ControlUtils.getControlAggregationByName(this.runtimeControl, selectedItemText));
            newSelectedControlChildren = newSelectedControlChildren.map(key => {
                return parseInt(key, radix);
            });
            this.specialIndexHandling(selectedItemText);
            const updatedIndexArray = this.fillIndexArray(newSelectedControlChildren);
            this.model.setProperty('/index', updatedIndexArray);
            this.model.setProperty('/selectedIndex', updatedIndexArray.length - 1);
        },
        onCreateBtnPress: async function _onCreateBtnPress(event) {
            const source = event.getSource();
            source.setEnabled(false);
            const fragmentName = this.model.getProperty('/newFragmentName');
            const index = this.model.getProperty('/selectedIndex');
            const targetAggregation = this.model.getProperty('/selectedAggregation/value');
            const fragmentData = {
                index,
                fragmentName,
                targetAggregation
            };
            const templateName = await this.createFragmentChange(fragmentData);
            const textKey = templateName ? 'ADP_ADD_FRAGMENT_WITH_TEMPLATE_NOTIFICATION' : 'ADP_ADD_FRAGMENT_NOTIFICATION';
            const bundle = await getTextBundle();
            notifyUser(bundle.getText(textKey, [fragmentName]), 8000);
            this.handleDialogClose();
        },
        buildDialogData: async function _buildDialogData() {
            const {controlMetadata, targetAggregation} = this.getControlMetadata();
            const defaultAggregation = this.options.aggregation ?? controlMetadata.getDefaultAggregationName();
            const selectedControlName = controlMetadata.getName();
            let selectedControlChildren = Object.keys(ControlUtils.getControlAggregationByName(this.runtimeControl, defaultAggregation));
            selectedControlChildren = selectedControlChildren.map(key => {
                return parseInt(key, radix);
            });
            this.model.setProperty('/selectedControlName', selectedControlName);
            this.model.setProperty('/selectedAggregation', {});
            const indexArray = this.fillIndexArray(selectedControlChildren);
            const controlAggregation = targetAggregation.map((elem, index) => {
                return {
                    key: index,
                    value: elem
                };
            });
            if (defaultAggregation !== null) {
                controlAggregation.forEach(obj => {
                    if (obj.value === defaultAggregation) {
                        obj.key = 'default';
                        this.model.setProperty('/selectedAggregation/key', obj.key);
                        this.model.setProperty('/selectedAggregation/value', obj.value);
                        this.specialIndexHandling(obj.value);
                    }
                });
            } else {
                this.model.setProperty('/selectedAggregation/key', controlAggregation[0].key);
                this.model.setProperty('/selectedAggregation/value', controlAggregation[0].value);
                this.specialIndexHandling(controlAggregation[0].value);
            }
            try {
                const {fragments} = await getFragments();
                this.model.setProperty('/fragmentList', fragments);
            } catch (e) {
                this.handleError(e);
            }
            this.model.setProperty('/selectedIndex', indexArray.length - 1);
            this.model.setProperty('/targetAggregation', controlAggregation);
            this.model.setProperty('/index', indexArray);
        },
        createFragmentChange: async function _createFragmentChange(fragmentData) {
            const {fragmentName, index, targetAggregation} = fragmentData;
            const flexSettings = this.rta.getFlexSettings();
            const overlay = OverlayRegistry.getOverlay(this.runtimeControl);
            const designMetadata = overlay.getDesignTimeMetadata();
            const modifiedValue = {
                fragment: `<core:FragmentDefinition xmlns:core='sap.ui.core'></core:FragmentDefinition>`,
                fragmentPath: `fragments/${ fragmentName }.fragment.xml`,
                index: index ?? 0,
                targetAggregation: targetAggregation ?? 'content'
            };
            const command = await this.commandExecutor.getCommand(this.runtimeControl, 'addXML', modifiedValue, designMetadata, flexSettings);
            const templateName = this.getFragmentTemplateName(modifiedValue.targetAggregation);
            if (templateName) {
                const preparedChange = command.getPreparedChange();
                const content = preparedChange.getContent();
                preparedChange.setContent({
                    ...content,
                    templateName
                });
                CommunicationService.sendAction(setApplicationRequiresReload(true));
            }
            await this.commandExecutor.pushAndExecuteCommand(command);
            return templateName;
        },
        getFragmentTemplateName: function _getFragmentTemplateName(targetAggregation) {
            const currentControlName = this.runtimeControl.getMetadata().getName();
            if (currentControlName === 'sap.uxap.ObjectPageLayout' && targetAggregation === 'sections') {
                return 'OBJECT_PAGE_CUSTOM_SECTION';
            } else if (this.isCustomAction(currentControlName, targetAggregation)) {
                return 'CUSTOM_ACTION';
            } else if (this.isObjectPageHeaderField(currentControlName, targetAggregation)) {
                return 'OBJECT_PAGE_HEADER_FIELD';
            } else if (currentControlName === 'sap.ui.mdc.Table' && targetAggregation === 'columns') {
                return 'V4_MDC_TABLE_COLUMN';
            } else if ([
                    TREE_TABLE_TYPE,
                    GRID_TABLE_TYPE,
                    ANALYTICAL_TABLE_TYPE
                ].includes(currentControlName) && targetAggregation === 'columns') {
                return 'ANALYTICAL_TABLE_COLUMN';
            } else if (currentControlName === 'sap.ui.mdc.ActionToolbar' && targetAggregation === 'actions') {
                return 'TABLE_ACTION';
            }
            return '';
        },
        isCustomAction: function _isCustomAction(currentControlName, targetAggregation) {
            if ([
                    'sap.f.DynamicPageTitle',
                    'sap.uxap.ObjectPageHeader',
                    'sap.uxap.ObjectPageDynamicHeaderTitle'
                ].includes(currentControlName)) {
                return targetAggregation === 'actions';
            } else if (currentControlName === 'sap.m.OverflowToolbar' || currentControlName === 'sap.m.Toolbar') {
                return targetAggregation === 'content';
            }
            return false;
        },
        isObjectPageHeaderField: function _isObjectPageHeaderField(currentControlName, targetAggregation) {
            if (currentControlName === 'sap.uxap.ObjectPageLayout') {
                return targetAggregation === 'headerContent';
            } else if (currentControlName === 'sap.m.FlexBox') {
                const parentName = this.runtimeControl.getParent()?.getMetadata().getName();
                if (parentName === 'sap.uxap.ObjectPageDynamicHeaderContent' || parentName === 'sap.uxap.ObjectPageLayout') {
                    return targetAggregation === 'items';
                }
            }
            return false;
        }
    });
    return AddFragment;
});